@model IEnumerable<ToDo.Models.Item>

@{
    ViewBag.Title = "Home Page";
}

<script>
    $(document).ready(function () {
        $("#itemSortable .static").each(function () {
             $(this).attr("id", "static-" + $(this).index());
        }); 
   
        $("#itemSortable").sortable({
            placeholder: 'ui-state-highlight',
            dropOnEmpty: true,
            revert: true,
            axis: "x",
            opacity: 0.5,
            cancel: ".disable-item-sorting",
            update: function (event, ui) {
                
                 $("#itemSortable .static").each(function() {
                    debugger
                   var desiredLocation = $(this).attr("id").replace("static-","");
                   var currentLocation = $(this).index();
                   while(currentLocation < desiredLocation) {
                     $(this).next().insertBefore(this);
                      currentLocation++;  
                    }
                    while(currentLocation > desiredLocation) {
                     $(this).prev().insertAfter(this);
                      currentLocation--;  
                    }
                });




                var itemIds = "";
                $("#itemSortable").find(".parent-card").each(function () {
                    var itemId = $(this).attr("data-item-id");
                    itemIds = itemIds + "," + itemId;
                });
                $.ajax({
                    url: '@Url.Action("UpdateItem", "Home")',
                    data: { itemIds: itemIds },
                    type: 'POST',
                    success: function (data) {

                    },
                    error: function (xhr, status, error) {

                    }

                });
            }
        });

        $("div[id^='subItemsortable']").sortable({
            opacity: 0.5,
            revert: true,
            dropOnEmpty: true,
            scroll: true,
            update: function (event, ui) {
                debugger

                var itemIds = "";
                $("div[id*='subItemsortable']").find(".parent-card").each(function () {
                    var itemId = $(this).attr("data-item-id");
                    itemIds = itemIds + "," + itemId;
                });
                $.ajax({
                    url: '@Url.Action("UpdateSubItem", "Home")',
                    data: { itemIds: itemIds },
                    type: 'POST',
                    success: function (data) {

                    },
                    error: function (xhr, status, error) {

                    }

                });
            },
            stop: function (event, ui) {
                debugger

            },
            receive: function(event, ui) {
                debugger
            },
            connectWith: "div[class*='sortable']"
        });

    });
</script>

<div class="page-header header-filter" data-parallax="true" style="background-image: url('../assets/img/bg7.jpg')">
    <div class="container">
        <div class="card-block" id="itemSortable">
            @foreach (var item in Model)
            {
                <div class="card parent-card" id="item@(item.Id)" data-item-id="@(item.Id)">
                    <div class="card-header card-header-primary parent-card-header">
                        @item.Name
                    </div>
                    <div id="subItemsortable@(item.Id)" class="disable-item-sorting card-body parent-card-body sortable">
                        @{
                            if (item.Children != null)
                            {
                                foreach (var child in item.Children)
                                {
                                    <div class="card sub-card"  id="child@(child.Id + "|" + item.Id)" data-item-id="@(child.Id + "|" + item.Id)">
                                        <div class="card-body">
                                            @child.Name
                                        </div>
                                        <div class="  edit-card">
                                            <a href="#pablo" class="disable-item-sorting btn btn-success btn-sm btn-just-icon btn-fill btn-round btn-wd">
                                                <i class="material-icons">mode_edit</i>
                                            </a>
                                        </div>
                                    </div>
                                }
                            }
                        }


                    </div>
                    <div class="disable-item-sorting card-footer parent-card-footer" style="">
                        <span>+ New sub-item</span>
                    </div>
                </div>
            }
            <div class="card parent-card new-parent-card disable-item-sorting static" data-item-id="-1">
                <div class="card-header card-header-primary parent-card-header">
                   + New item
                </div>
            </div>
        </div>

    </div>
</div>
